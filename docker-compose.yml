services:
  # =========================
  # CORE
  # =========================
  core-db:
    image: postgres:15
    container_name: casuse-hp-core-db
    environment:
      POSTGRES_USER: casuse_hp
      POSTGRES_PASSWORD: casuse_hp
      POSTGRES_DB: casuse_hp
    ports:
      - "20011:5432"
    volumes:
      - core-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp -d casuse_hp"]
      interval: 5s
      timeout: 5s
      retries: 10

  core-backend:
    build: ./core-backend
    container_name: casuse-hp-core-backend
    env_file:
      - .env
    depends_on:
      core-db:
        condition: service_healthy
    ports:
      - "20010:20010"
    command: >
      sh -c "alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 20010"

  core-frontend:
    build: ./core-frontend
    container_name: casuse-hp-core-frontend
    ports:
      - "20020:80"
    depends_on:
      - core-backend

  # =========================
  # MODULE: VERKOOP
  # =========================
  verkoop-db:
    image: postgres:15
    container_name: casuse-hp-verkoop-db
    environment:
      POSTGRES_USER: casuse_hp_verkoop
      POSTGRES_PASSWORD: casuse_hp_verkoop
      POSTGRES_DB: casuse_hp_verkoop
    ports:
      - "20031:5432"
    volumes:
      - verkoop-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_verkoop -d casuse_hp_verkoop"]
      interval: 5s
      timeout: 5s
      retries: 10

  verkoop-backend:
    build: ./modules/verkoop/backend
    container_name: casuse-hp-verkoop-backend
    environment:
      APP_PORT: 20030
      DATABASE_URL: postgresql+psycopg://casuse_hp_verkoop:casuse_hp_verkoop@verkoop-db:5432/casuse_hp_verkoop
    depends_on:
      verkoop-db:
        condition: service_healthy
    ports:
      - "20030:20030"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20030"

  verkoop-frontend:
    build: ./modules/verkoop/frontend
    container_name: casuse-hp-verkoop-frontend
    ports:
      - "20040:80"

  # =========================
  # MODULE: WEBSITE
  # =========================
  website-db:
    image: postgres:15
    container_name: casuse-hp-website-db
    environment:
      POSTGRES_DB: casuse_hp_website
      POSTGRES_USER: website_user
      POSTGRES_PASSWORD: website_password   # LOCAL DEV ONLY
    ports:
      - "20051:5432"
    volumes:
      - website-db-data:/var/lib/postgresql/data
    networks:
      - default

  website-backend:
    build:
      context: ./modules/website/backend
    image: casuse-hp-website-backend
    container_name: casuse-hp-website-backend
    depends_on:
      - website-db
    environment:
      WEBSITE_DB_HOST: website-db
      WEBSITE_DB_PORT: 5432
      WEBSITE_DB_NAME: casuse_hp_website
      WEBSITE_DB_USER: website_user
      WEBSITE_DB_PASSWORD: website_password

      WEBSITE_BACKEND_PORT: 8000
      WEBSITE_JWT_SECRET: "CHANGE_ME_LOCAL_ONLY"
      WEBSITE_JWT_ALGORITHM: "HS256"
      WEBSITE_ACCESS_TOKEN_EXPIRE_MINUTES: "60"
      WEBSITE_REGISTRATION_TOKEN_TTL_MINUTES: "60"

      WEBSITE_ENV: "local"

      WEBSITE_CORS_ORIGINS: "http://localhost:20060,http://localhost:5173,http://localhost:20190,https://www.casuse.mx,https://casuse.mx"
      WEBSITE_PUBLIC_BASE_URL: "http://localhost:20190"

      # ==== NIEUW: e-mail / MailHog settings voor website-backend ====
      WEBSITE_EMAIL_ENABLED: "true"
      WEBSITE_SMTP_HOST: "website-mailhog"
      WEBSITE_SMTP_PORT: "1025"
      WEBSITE_SMTP_TLS: "false"
      WEBSITE_SMTP_USERNAME: ""
      WEBSITE_SMTP_PASSWORD: ""
      WEBSITE_EMAIL_FROM: "no-reply@casuse.mx"

    ports:
      - "20052:8000"
    networks:
      - default

  website-frontend:
    build:
      context: ./modules/website/frontend
      args:
        VITE_WEBSITE_API_BASE_URL: "http://localhost:20052"
    image: casuse-hp-website-frontend
    container_name: casuse-hp-website-frontend
    depends_on:
      - website-backend
    environment:
      VITE_WEBSITE_API_BASE_URL: "http://localhost:20052"
    ports:
      - "20060:80"
    networks:
      - default

  website-mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: casuse-hp-website-mailhog
    restart: unless-stopped
    ports:
      - "20053:8025"   # Web UI: http://localhost:20053
    networks:
      - default



  # =========================
  # MODULE: INVENTARIES
  # =========================
  inventaries-db:
    image: postgres:15
    container_name: casuse-hp-inventaries-db
    environment:
      POSTGRES_USER: casuse_hp_inventaries
      POSTGRES_PASSWORD: casuse_hp_inventaries
      POSTGRES_DB: casuse_hp_inventaries
    ports:
      - "20071:5432"
    volumes:
      - inventaries-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_inventaries -d casuse_hp_inventaries"]
      interval: 5s
      timeout: 5s
      retries: 10

  inventaries-backend:
    build: ./modules/inventaries/backend
    container_name: casuse-hp-inventaries-backend
    environment:
      APP_PORT: 20070
      DATABASE_URL: postgresql+psycopg://casuse_hp_inventaries:casuse_hp_inventaries@inventaries-db:5432/casuse_hp_inventaries
    depends_on:
      inventaries-db:
        condition: service_healthy
    ports:
      - "20070:20070"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20070"

  inventaries-frontend:
    build: ./modules/inventaries/frontend
    container_name: casuse-hp-inventaries-frontend
    ports:
      - "20080:80"

  # =========================
  # MODULE: FACTURATIE
  # =========================
  facturatie-db:
    image: postgres:15
    container_name: casuse-hp-facturatie-db
    environment:
      POSTGRES_USER: casuse_hp_facturatie
      POSTGRES_PASSWORD: casuse_hp_facturatie
      POSTGRES_DB: casuse_hp_facturatie
    ports:
      - "20101:5432"
    volumes:
      - facturatie-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_facturatie -d casuse_hp_facturatie"]
      interval: 5s
      timeout: 5s
      retries: 10

  facturatie-backend:
    build: ./modules/facturatie/backend
    container_name: casuse-hp-facturatie-backend
    environment:
      APP_PORT: 20100
      DATABASE_URL: postgresql+psycopg://casuse_hp_facturatie:casuse_hp_facturatie@facturatie-db:5432/casuse_hp_facturatie
    depends_on:
      facturatie-db:
        condition: service_healthy
    ports:
      - "20100:20100"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20100"

  facturatie-frontend:
    build: ./modules/facturatie/frontend
    container_name: casuse-hp-facturatie-frontend
    ports:
      - "20110:80"

  # =========================
  # MODULE: MAGAZIJN
  # =========================
  magazijn-db:
    image: postgres:15
    container_name: casuse-hp-magazijn-db
    environment:
      POSTGRES_USER: casuse_hp_magazijn
      POSTGRES_PASSWORD: casuse_hp_magazijn
      POSTGRES_DB: casuse_hp_magazijn
    ports:
      - "20121:5432"
    volumes:
      - magazijn-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_magazijn -d casuse_hp_magazijn"]
      interval: 5s
      timeout: 5s
      retries: 10

  magazijn-backend:
    build: ./modules/magazijn/backend
    container_name: casuse-hp-magazijn-backend
    environment:
      APP_PORT: 20120
      DATABASE_URL: postgresql+psycopg://casuse_hp_magazijn:casuse_hp_magazijn@magazijn-db:5432/casuse_hp_magazijn
    depends_on:
      magazijn-db:
        condition: service_healthy
    ports:
      - "20120:20120"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20120"

  magazijn-frontend:
    build: ./modules/magazijn/frontend
    container_name: casuse-hp-magazijn-frontend
    ports:
      - "20130:80"

  # =========================
  # MODULE: PRODUCTIE
  # =========================
  productie-db:
    image: postgres:15
    container_name: casuse-hp-productie-db
    environment:
      POSTGRES_USER: casuse_hp_productie
      POSTGRES_PASSWORD: casuse_hp_productie
      POSTGRES_DB: casuse_hp_productie
    ports:
      - "20141:5432"
    volumes:
      - productie-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_productie -d casuse_hp_productie"]
      interval: 5s
      timeout: 5s
      retries: 10

  productie-backend:
    build: ./modules/productie/backend
    container_name: casuse-hp-productie-backend
    environment:
      APP_PORT: 20140
      DATABASE_URL: postgresql+psycopg://casuse_hp_productie:casuse_hp_productie@productie-db:5432/casuse_hp_productie
    depends_on:
      productie-db:
        condition: service_healthy
    ports:
      - "20140:20140"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20140"

  productie-frontend:
    build: ./modules/productie/frontend
    container_name: casuse-hp-productie-frontend
    ports:
      - "20150:80"

  # =========================
  # MODULE: OVERZICHT-MODULES
  # =========================
  overzicht-modules-db:
    image: postgres:15
    container_name: casuse-hp-overzicht-modules-db
    environment:
      POSTGRES_USER: casuse_hp_overzicht_modules
      POSTGRES_PASSWORD: casuse_hp_overzicht_modules
      POSTGRES_DB: casuse_hp_overzicht_modules
    ports:
      - "20161:5432"
    volumes:
      - overzicht-modules-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casuse_hp_overzicht_modules -d casuse_hp_overzicht_modules"]
      interval: 5s
      timeout: 5s
      retries: 10

  overzicht-modules-backend:
    build: ./modules/overzicht-modules/backend
    container_name: casuse-hp-overzicht-modules-backend
    environment:
      APP_PORT: 20160
      DATABASE_URL: postgresql+psycopg://casuse_hp_overzicht_modules:casuse_hp_overzicht_modules@overzicht-modules-db:5432/casuse_hp_overzicht_modules
    depends_on:
      overzicht-modules-db:
        condition: service_healthy
    ports:
      - "20160:20160"
    command: >
      sh -c "uvicorn app:app --host 0.0.0.0 --port 20160"

  overzicht-modules-frontend:
    build: ./modules/overzicht-modules/frontend
    container_name: casuse-hp-overzicht-modules-frontend
    ports:
      - "20162:80"

  # =========================
  # AI / TOOLS
  # =========================
  ai-tools:
    build: ./ai-tools
    container_name: casuse-hp-ai-tools
    ports:
      - "20170:20170"
    command: >
      uvicorn app:app --host 0.0.0.0 --port 20170

volumes:
  core-db-data:
  verkoop-db-data:
  website-db-data:
  inventaries-db-data:
  facturatie-db-data:
  magazijn-db-data:
  productie-db-data:
  overzicht-modules-db-data:
